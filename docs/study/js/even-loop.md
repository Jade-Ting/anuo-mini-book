---
title: '事件循环'
order: 3
---

<Alert>JavaScript 有一个基于事件循环的并发模型（并发模型还不是很理解），事件循环负责执行、收集和处理事件以及执行队列中的子任务。</Alert>

![描述事件循环机制](https://mdn.mozillademos.org/files/17124/The_Javascript_Runtime_Environment_Example.svg)

如图：

- 栈（stack）：用于 JS 的函数嵌套调用，按顺序执行事件，执行一个事件则加入一帧，执行完成则去掉一帧。遵循后进先出原则，全部执行完，则栈被清空。
- 堆（heap）：用于存储大块数据的内存区域，比如对象。
- 队列（queue）：用于事件循环机制，先进先出，直到队列为空。

## 栈

> 函数调用形成了一个由若干帧组成的栈

```js
function foo(b) {
  let a = 10;
  return a + b + 11;
}

function bar(x) {
  let y = 3;
  return foo(x * y);
}

function baz() {
  console.log('==运行baz()==');
}

console.log(bar(7)); // 返回 42
baz();
```

- 当调用 `bar` 时， 第一个帧被创建并压入栈中，帧中包含了 `bar` 的参数和局部变量。当 `bar` 调用 `foo` 时，第二个帧被创建并压入栈中，放在第一个帧之上，帧中包含 `foo` 的参数和局部变量，当 `foo` 执行完毕后返回时第二个帧就被弹出栈（剩下`bar`函数的调用帧）。当 `bar` 也执行完返回时，第一个帧也被弹出。栈就被清空了。
- 然后调用`baz`时，又会创造一个新的栈帧，直到 `baz` 执行完成被弹出栈，栈又会被清空。

## 堆

> 对象被分配在堆中，堆是用来表示一大块内存区域的计算机术语。

## 队列

> 一个 JavaScript 运行时包含了一个待处理消息的任务队列，每一个消息都关联着一个用以处理这个消息的回调函数。

在事件循环期间的某个时刻，运行时会从最先进入队列的消息开始处理队列中的消息。被梳理的消息会被移出队列，并作为输入参数来调用与之关联的函数。正如前面所提的，调用一个函数总是会为其创造一个新的栈帧。

函数的处理会一直进行到执行栈再次为空为止，然后事件循环将会处理队列中的下一个消息（如果还有的话）。

## 事件循环

[动图学 JavaScript 之：事件循环（Event Loop）](https://segmentfault.com/a/1190000021445387?utm_source=sf-related)

待补充...
